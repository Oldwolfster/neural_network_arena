from src.reports._BaseReport import BaseReport
from src.engine.RamDB import RamDB


class ReportingMadeEasy(BaseReport):
    def purpose(self) -> str:
        return "📝 Purpose: Verify that each forward pass computes correctly by logging neuron activations across the network."

    def what_to_look_for(self) -> str:
        return """If all activations look the same for every input, something is wrong.
                  If hidden layer activations are all close to 1 or -1, sigmoid/tanh is saturating.
                    If activation is always ~0.5, we have bad weight initialization.        
                """

    def report_logic(self, *args):
        """
        This method is invoked when user selects this report from Report Menu
        """
        SQL =   """
                SELECT 
                    epoch_n, iteration_n, layer_id, nid,
                    activation_value AS activation_output, activation_gradient, raw_sum, 
                    bias, weights
                FROM Neuron
                WHERE epoch_n % 100 = 0  -- Only show every 10 epochs
                -- AND model = ?        -- Optional: Add a filter for a specific model
                ORDER BY epoch_n, iteration_n, layer_id, nid;
                """
        self.run_sql_report(SQL)

    def __init__(self, *args):
        super().__init__(*args)
        self.dbRam = args[0]

"""
 model          │   epoch_n │   iteration_n │   activation_gradient │ activation_name   │   activation_value │     bias │   bias_before │   error_signal │ error_signal_calcs   │   layer_id │ layers   │   learning_rate │ neuron_inputs                            │   nid │   num_of_weights │   position │   raw_sum │ weight_adjustments                                      │ weights                                    │ weights_before                             │
╞════════════════╪═══════════╪═══════════════╪═══════════════════════╪═══════════════════╪════════════════════╪══════════╪═══════════════╪════════════════╪══════════════════════╪════════════╪══════════╪═════════════════╪══════════════════════════════════════════╪═══════╪══════════════════╪════════════╪═══════════╪═════════════════════════════════════════════════════════╪════════════════════════════════════════════╪════════════════════════════════════════════╡
│ XOR_TheLongWay │         1 │             1 │              0.612409 │ Tanh              │           0.729188 │ 0.89739  │      0.926991 │      -0.296019 │ 1.64!-0.295@         │          0 │          │             0.1 │ [0.0, 0.0]                               │     0 │                2 │          0 │  0.926991 │ w0 Neuron ID0,0 = 0.35919 + 0.1 * -0.296019 * 0         │ [0.3591895572391617, -0.24821124112262827] │ [0.3591895572391617, -0.24821124112262827] │
│                │           │               │                       │                   │                    │          │               │                │                      │            │          │                 │                                          │       │                  │            │           │ w1 Neuron ID0,0 = -0.248211 + 0.1 * -0.296019 * 0       │                                            │                                            │
│                │           │               │                       │                   │                    │          │               │                │                      │            │          │                 │                                          │       │                  │            │           │ B = 0.926991 + 0.1 * -0.296019                          │                                            │                                            │
├────────────────┼───────────┼───────────────┼───────────────────────┼───────────────────┼────────────────────┼──────────┼───────────────┼────────────────┼──────────────────────┼────────────┼──────────┼─────────────────┼──────────────────────────────────────────┼───────┼──────────────────┼────────────┼───────────┼─────────────────────────────────────────────────────────┼────────────────────────────────────────────┼────────────────────────────────────────────┤
│ XOR_TheLongWay │         1 │             1 │              0.798039 │ Tanh              │           0.483949 │ 0.562587 │      0.528128 │       0.344589 │ -1.46!-0.295@        │          0 │          │             0.1 │ [0.0, 0.0]                               │     1 │                2 │          1 │  0.528128 │ w0 Neuron ID0,1 = 1.641537 + 0.1 * 0.344589 * 0         │ [1.641537343887666, 1.5371356739552207]    │ [1.641537343887666, 1.5371356739552207]    │
│                │           │               │                       │                   │                    │          │               │                │                      │            │          │                 │                                          │       │                  │            │           │ w1 Neuron ID0,1 = 1.537136 + 0.1 * 0.344589 * 0         │                                            │                                            │
│                │           │               │                       │                   │                    │          │               │                │                      │            │          │                 │                                          │       │                  │            │           │ B = 0.528128 + 0.1 * 0.344589                           │                                            │                                            │
├────────────────┼───────────┼───────────────┼───────────────────────┼───────────────────┼────────────────────┼──────────┼───────────────┼────────────────┼──────────────────────┼────────────┼──────────┼─────────────────┼──────────────────────────────────────────┼───────┼──────────────────┼────────────┼───────────┼─────────────────────────────────────────────────────────┼────────────────────────────────────────────┼────────────────────────────────────────────┤
│ XOR_TheLongWay │         1 │             1 │              0.212911 │ Sigmoid           │           0.692586 │ 0.296169 │      0.325661 │      -0.294918 │                      │          1 │          │             0.1 │ [0.7291881489900603, 0.4839489427986665] │     2 │                2 │          0 │  0.812238 │ w0 Neuron ID1,0 = 1.638996 + 0.1 * -0.294918 * 0.729188 │ [1.6174909941330304, -1.4783921019352464]  │ [1.6389960520732534, -1.4641195852063207]  │
│                │           │               │                       │                   │                    │          │               │                │                      │            │          │                 │                                          │       │                  │            │           │ w1 Neuron ID1,0 = -1.46412 + 0.1 * -0.294918 * 0.483949 │                                            │                                            │
│                │           │               │                       │                   │                    │          │               │                │                      │            │          │                 │                                          │       │                  │            │           │ B = 0.325661 + 0.1 * -0.294918                          │                                            │                                            │
╘════════════════╧═══════════╧═══════════════╧═══════════════════════╧═══════════════════╧════════════════════╧══════════╧═══════════════╧════════════════╧══════════════════════╧════════════╧══════════╧═════════════════╧══════════════════════════════════════════╧═══════╧══════════════════╧════════════╧═══════════╧═════════════════════════════════════════════════════════╧════════════════════════════════════════════╧════════════════════════════════════════════╛
╒══════════════════╤══════════════════════╤═════════╤═══════════╤══════════╤════════════╤═════════════════════╤═════════════════════╤═══════════╤════════════════════╤════════════════════╤═════════════╤══════════╤═════════════════╤════════════════╤══════════════╤══════════════════╤══════════════════╤═════════════════╤══════════╕
│   absolute_error │   accuracy_threshold │   epoch │     error │ inputs   │   is_false │   is_false_negative │   is_false_positive │   is_true │   is_true_negative │   is_true_positive │   iteration │     loss │   loss_gradient │ model_id       │   prediction │   prediction_raw │   relative_error │   squared_error │   target │
╞══════════════════╪══════════════════════╪═════════╪═══════════╪══════════╪════════════╪═════════════════════╪═════════════════════╪═══════════╪════════════════════╪════════════════════╪═════════════╪══════════╪═════════════════╪════════════════╪══════════════╪══════════════════╪══════════════════╪═════════════════╪══════════╡
│         0.692586 │                  0.1 │       1 │ -0.692586 │ [0, 0]   │          1 │                   0 │                   1 │         0 │                  0 │                  0 │           1 │ 0.479676 │       -1.38517  │ XOR_TheLongWay │            1 │         0.692586 │      6.92586e+63 │        0.479676 │        0 │
├──────────────────┼──────────────────────┼─────────┼───────────┼──────────┼────────────┼─────────────────────┼─────────────────────┼───────────┼────────────────────┼────────────────────┼─────────────┼──────────┼─────────────────┼────────────────┼──────────────┼──────────────────┼──────────────────┼─────────────────┼──────────┤
│         0.55348  │                  0.1 │       1 │  0.55348  │ [0, 1]   │          1 │                   1 │                   0 │         0 │                  0 │                  0 │           2 │ 0.30634  │        1.10696  │ XOR_TheLongWay │            0 │         0.44652  │      0.55348     │        0.30634  │        1 │
├──────────────────┼──────────────────────┼─────────┼───────────┼──────────┼────────────┼─────────────────────┼─────────────────────┼───────────┼────────────────────┼────────────────────┼─────────────┼──────────┼─────────────────┼────────────────┼──────────────┼──────────────────┼──────────────────┼─────────────────┼──────────┤
│         0.422992 │                  0.1 │       1 │  0.422992 │ [1, 0]   │          1 │                   1 │                   0 │         0 │                  0 │                  0 │           3 │ 0.178922 │        0.845984 │ XOR_TheLongWay │            1 │         0.577008 │      0.422992    │        0.178922 │        1 │
╘══════════════════╧══════════════════════╧═════════╧═══════════╧══════════╧════════════╧═════════════════════╧═════════════════════╧═══════════╧═══════════════

"""